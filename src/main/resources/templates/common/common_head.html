<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:fragment="commonHeader(title)">
<title th:text="${title}"></title>
<meta charset="utf-8"/>
<!-- 导入Easy UI的主题Css文件 -->
<link th:href="@{/easyui/themes/default/easyui.css}" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" th:href="@{/uploadify/uploadify.css}"/>
<!-- 导入Easy UI的图标Css文件 -->
<link th:href="@{/easyui/themes/icon.css}" rel="stylesheet" type="text/css" />
<link  th:href="@{/ztree/zTreeStyle.css}" rel="stylesheet" type="text/css"/>
<style type="text/css">
table.gridtable {
	font-family: verdana,arial,sans-serif;
	font-size:11px;
	color:#333333;
	border-width: 1px;
	border-color: #666666;
	border-collapse: collapse;
}
table.gridtable th {
	border-width: 1px;
	padding: 8px;
	border-style: solid;
	border-color: #666666;
	background-color: #eee;
	text-align: center;
}

table.gridtable td {
	border-width: 1px;
	border-style: solid;
	border-color: #666666;
	text-align: center;
}
table.gridtable tr{
   min-height: 30px;
}
#fm {
	margin: 0;
	padding: 10px 30px;
}

.ftitle {
	font-size: 14px;
	font-weight: bold;
	padding: 5px 0;
	margin-bottom: 10px;
	border-bottom: 1px solid #ccc;
}

.fitem {
	margin-bottom: 5px;
}

.fitem label {
	display: inline-block;
	width: 80px;
}

.fitem input {
	width: 160px;
}
</style>
</head>
<body>
<div th:fragment="onloadJs">
<script th:src="@{/easyui/js/jquery.min.js}" type="text/javascript"></script>
<!-- 引用Easy UI的Js文件 -->
<script th:src="@{/easyui/js/jquery.easyui.min.js}" type="text/javascript"></script>
<script th:src="@{/easyui/js/easyui-lang-zh_CN.js}" type="text/javascript"></script>
<script th:src="@{/easyui/js/datagrid-filter.js}" type="text/javascript"></script>
<script th:src="@{/uploadify/jquery.uploadify.min.js}" type="text/javascript"></script>
<script th:src="@{/easyui/js/datagrid-detailview.js}" type="text/javascript"></script>
	<script type="text/javascript" th:src="@{/ztree/jquery.ztree.core.js}"></script>
	<script type="text/javascript" th:src="@{/ztree/jquery.ztree.excheck.js}"></script>
	<script type="text/javascript" th:src="@{/highcharts/highcharts.js}"></script>
	<script type="text/javascript" th:src="@{/highcharts/exporting.js}"></script>
	<script type="text/javascript" th:src="@{/highcharts/grid.js}"></script>
		<script type="text/javascript" th:src="@{/easyui/js/vue.js}"></script>
	<script type="text/javascript">
	  /*<![CDATA[*/
	  
	  $.extend($.fn.validatebox.defaults.rules, {
             newRule: {
		       validator: function(value,param){
		         if(!/^[\d\w\-\~]*$/.test(value)){
		            var $this = $(this);
		            setTimeout(function(){
		              $this.val('')
		            },1500)
		         }
			     return /^[\d\w\-\~]*$/.test(value);
		       },
		      message: '请按规则拆分,只允许出现~和-和数字'
            }
           });
	  
	$(function (){
		$("body").keydown(function() { if (event.keyCode == "13") { 
		if(typeof(endEditing)=="function"){
		   endEditing();
		   setTimeout(function (){
		     $('.searchBtn').click();
		   },500)
		}else{
		   $('.searchBtn').click();
		}
		 } });
	})
	
	function nextProcess(type,processId){
	    if(typeof  endEditing=="function"){
	       endEditing();
	    }
	   var rows = $("#dg").datagrid('getSelections');
	    if(rows.length==0){
	       $.messager.alert('提示信息', '请至少选择一条数据!', 'warning');
	       return false;
	    }
	    var ids = "";
		for (var x = 0; x < rows.length; x++) {
		  if (x == 0) {
			  ids = rows[x].id;
		  } else {
			  ids = ids + "," + rows[x].id;
		  }
		 }
		 
/* 		 if(type==2&&processId!=4){
		     $('<div></div>').dialog({
            id : 'newDialog',
            title : '填写转出日期',
            width:400,
            height:200,
            closed : false,
            cache : false,
            href : '/hgerp/product/setOutDate?ids='+ids+'&type='+type,
            modal : true,
            onLoad : function() {
                //初始化表单数据
            },
            onClose : function() {
                $(this).dialog('destroy');
            },
            buttons : [{
                text : '确定',
                iconCls : 'icon-ok',
                handler : function() {
                	$('#fm').form('submit', { 
	                               url: '/hgerp/product/nextProcess',
	                               onSubmit: function(){
		                             var isValid = $(this).form('validate');
		                             return isValid;	// return false will stop the form submission
	                              },
	                              success: function(data){
	                                 if(data == 'fail'){
	                                     $.messager.alert('提示信息','模板数据不完整,请先完善!','warning');
	                                 }else if(data == 'success'){
	                                     $("#newDialog").dialog('destroy');
	                                     $.messager.show({
	                                                    title : '消息提示',
														msg : '操作成功！',
														timeout : 1000,
														showType : 'slide',
														style : {
															right : '',
															bottom : ''
														}
										});
										$('#dg').datagrid('clearSelections');
										$('#dg').datagrid('reload');
	                                 }
	                              }
                     });
                }
            }, {
                text : '关闭',
                iconCls : 'icon-cancel',
                handler : function() {
                    $("#newDialog").dialog('destroy');
                }
            } ],

        });
		     
		     return false;
		 } */
		 
		 $.messager.confirm('完成前请仔细确认', '确定继续操作吗?', function(r){
				if (r){
				    $.messager.progress({ 
                                  title: '提示', 
                                  msg: '加载中，请稍候……', 
                                  text: '' 
                    });
					$.ajax({
									type : "POST",
									url : "/hgerp/product/nextProcess",
									data : {
										ids : ids,
										type:type
									},
									success : function(data) {
									   $.messager.progress('close');
									   if(data=='success'){
									     $.messager.show({
											title : '消息提示',
											msg : '操作成功！',
											timeout : 1000,
											showType : 'slide',
											style : {
												right : '',
												bottom : ''
											}
										});
										$('#dg').datagrid('clearSelections');
										$('#dg').datagrid('reload');
									   }else if(data=='notAllow'){
									      $.messager.alert('提示信息', '该锻件必须先做检验再进入下个工序,谢谢配合', 'warning');
									   }else if(data=='notAllow2'){
									      $.messager.alert('提示信息', '出坯工序无法使用该功能!', 'warning');
									   }else{
									      $.messager.alert('提示信息', '操作失败!', 'warning');
									   }
									}
								})
				}
			});
	}
	
	  function toNcr(){
	    var rows = $("#dg").datagrid('getSelections');
	    if(rows.length==0){
	       $.messager.alert('提示信息', '请至少选择一条数据进行操作!', 'warning');
	       return false;
	    }
	    var ids = "";
		for (var x = 0; x < rows.length; x++) {
		  if (x == 0) {
			  ids = rows[x].id;
		  } else {
			  ids = ids + "," + rows[x].id;
		  }
		 }
	     $('<div></div>').dialog({
            id : 'newDialog',
            title : '发起不合格',
            width:600,
            height:400,
            closed : false,
            cache : false,
            href : '/hgerp/ncr/toNcr?ids='+ids,
            modal : true,
            onLoad : function() {
                //初始化表单数据
            },
            onClose : function() {
                $(this).dialog('destroy');
            },
            buttons : [{
                text : '确定',
                iconCls : 'icon-ok',
                handler : function() {
                    $.messager.progress({ 
                                  title: '提示', 
                                  msg: '加载中，请稍候……', 
                                  text: '' 
                    });
                	$('#fm').form('submit', { 
	                               url: '/hgerp/ncr/doNcr',
	                               onSubmit: function(){
		                             var isValid = $(this).form('validate');
		                             if(!isValid){
		                               $.messager.progress('close');
		                             }
		                             return isValid;	// return false will stop the form submission
	                              },
	                              success: function(data){
	                                 $.messager.progress('close');
	                                 if(data == 'fail'){
	                                     $.messager.alert('提示信息','模板数据不完整,请先完善!','warning');
	                                 }else if(data == 'success'){
	                                     $("#newDialog").dialog('destroy');
	                                     $.messager.show({
	                                                    title : '消息提示',
														msg : '操作成功！',
														timeout : 1000,
														showType : 'slide',
														style : {
															right : '',
															bottom : ''
														}
										});
										$('#dg').datagrid('clearSelections');
										$('#dg').datagrid('reload');
	                                 }
	                              }
                     });
                }
            }, {
                text : '关闭',
                iconCls : 'icon-cancel',
                handler : function() {
                    $("#newDialog").dialog('destroy');
                }
            } ],

        });
	  }
	  
	 var xxx = 0;
	 function split(){
	    var rows = $("#dg").datagrid('getSelections');
	    if(rows.length!=1){
	       $.messager.alert('提示信息', '请选择一条数据进行操作!', 'warning');
	       return false;
	    }
	     $('<div></div>').dialog({
            id : 'newDialog',
            title : '拆分',
            maximized:true,
            closed : false,
            cache : false,
            href : '/hgerp/product/toSplit?id='+rows[0].id,
            modal : true,
            onLoad : function() {
                //初始化表单数据
            },
            onClose : function() {
                xx[state]=xxx;
                $(this).dialog('destroy');
            },
            buttons : [{
                text : '确定',
                iconCls : 'icon-ok',
                handler : function() {
                   $.messager.progress({ 
                                  title: '提示', 
                                  msg: '加载中，请稍候……', 
                                  text: '' 
                    });
                   var isValid = $("#fm").form('validate');
					if (isValid) {
						var rows2 = $('#myList').datagrid('getRows');
						var xx = {};
						if (endEditingb()) {
							$('#myList').datagrid('acceptChanges');
						}
						for (var i = 0; i < rows2.length; i++) {
							for ( var key in rows2[i]) {
								xx["listP[" + i + "]."+ key] = rows2[i][key];
							}
						}
						var formData = $("#fm").serializeArray();
						for ( var n in formData) {
							var data = formData[n];
							xx[data.name] = data.value;
						}
						xx['state']=xxx;
						$.ajax({    url : '/hgerp/product/doSplit',
									data : xx,
									async:false,
									success : function(res) {
									        $.messager.progress('close');
											if (res == 'success') {
											    xxx=0;
												$("#newDialog").dialog('destroy');
												$.messager.show({
													title : '消息提示',
													msg : '操作成功！',
													timeout : 1000,
													showType : 'slide',
													style : {
														right : '',
														bottom : ''
													}
												});
												$('#dg').datagrid('reload');
												$('#dg').datagrid('clearSelections');
											}
											if (res == 'fail') {
											    $.messager.alert('提示信息', '至少添加两行!', 'warning');
											}
											if (res == 'qty') {
											    $.messager.alert('提示信息', '数量必填!', 'warning');
											}
											if (res == 'fail3'&&xxx==0) {
											    xxx=1;
											    $.messager.alert('提示信息', '范围填写格式疑似有误,如果还要继续执行,请再次点击确定!', 'error');
											}
									}
								})
							} else {
							    $.messager.progress('close');
                                $.messager.alert('提示信息', '请将数据填写完整!', 'warning');
							}
                }
            }, {
                text : '关闭',
                iconCls : 'icon-cancel',
                handler : function() {
                    $("#newDialog").dialog('destroy');
                    xx[state]=xxx;
                }
            } ],

        });
	  }
	  
	function outside(){
	   if(typeof  endEditing=="function"){
	       endEditing();
	    }
	   var rows = $("#dg").datagrid('getSelections');
	    if(rows.length==0){
	       $.messager.alert('提示信息', '请至少选择一条数据!', 'warning');
	       return false;
	    }
	    var ids = "";
		for (var x = 0; x < rows.length; x++) {
		  if (x == 0) {
			  ids = rows[x].id;
		  } else {
			  ids = ids + "," + rows[x].id;
		  }
		 }
		 $.messager.confirm('完成前请仔细确认', '确定外协吗?', function(r){
				if (r){
				    $.messager.progress({ 
                                  title: '提示', 
                                  msg: '加载中，请稍候……', 
                                  text: '' 
                    });
					$.ajax({
									type : "POST",
									url : "/hgerp/product/outside",
									data : {
										ids : ids
									},
									success : function(data) {
									   $.messager.progress('close');
									   if(data=='success'){
									     $.messager.show({
											title : '消息提示',
											msg : '操作成功！',
											timeout : 1000,
											showType : 'slide',
											style : {
												right : '',
												bottom : ''
											}
										});
										$('#dg').datagrid('clearSelections');
										$('#dg').datagrid('reload');
									   }else{
									      $.messager.alert('提示信息', '操作失败!', 'warning');
									   }
									}
								})
				}
			});
	}
	function backwork(){
	   if(typeof  endEditing=="function"){
	       endEditing();
	    }
	   var rows = $("#dg").datagrid('getSelections');
	    if(rows.length==0){
	       $.messager.alert('提示信息', '请至少选择一条数据!', 'warning');
	       return false;
	    }
	    var ids = "";
		for (var x = 0; x < rows.length; x++) {
		  if (x == 0) {
			  ids = rows[x].id;
		  } else {
			  ids = ids + "," + rows[x].id;
		  }
		 }
		 $.messager.confirm('完成前请仔细确认', '确定回退到本厂页面吗?', function(r){
				if (r){
				    $.messager.progress({ 
                                  title: '提示', 
                                  msg: '加载中，请稍候……', 
                                  text: '' 
                    });
					$.ajax({
									type : "POST",
									url : "/hgerp/product/backWork",
									data : {
										ids : ids
									},
									success : function(data) {
									   $.messager.progress('close');
									   if(data=='success'){
									     $.messager.show({
											title : '消息提示',
											msg : '操作成功！',
											timeout : 1000,
											showType : 'slide',
											style : {
												right : '',
												bottom : ''
											}
										});
										$('#dg').datagrid('clearSelections');
										$('#dg').datagrid('reload');
									   }else{
									      $.messager.alert('提示信息', '操作失败!', 'warning');
									   }
									}
								})
				}
			});
	}
	
	function toMessageb(){
	     var rows = $("#dg").datagrid('getSelections');
	     if(rows.length==0){
	        $.messager.alert('提示信息', '请选择至少一条数据!', 'warning');
	        return false;
	     }
	     var ids = "";
		for (var x = 0; x < rows.length; x++) {
			if (x == 0) {
			   ids = rows[x].id;
			} else {
			   ids = ids + "," + rows[x].id;
			}
		}
	     $('<div></div>').dialog({
            id : 'newDialog',
            title : '发送站内信',
            width:500,
            height:350,
            closed : false,
            cache : false,
            href : '/hgerp/product/toMessage?ids='+ids,
            modal : false,
            onLoad : function() {
                //初始化表单数据
            },
            onClose : function() {
                $(this).dialog('destroy');
            },
            buttons : [{
                text : '确定',
                iconCls : 'icon-ok',
                handler : function() {
                    $.messager.progress({ 
                                  title: '提示', 
                                  msg: '加载中，请稍候……', 
                                  text: '' 
                    });
                	$('#fm').form('submit', { 
	                               url: '/hgerp/api/user/doMessage',
	                               onSubmit: function(){
		                             var isValid = $(this).form('validate');
		                             if(!isValid){
		                               $.messager.progress('close');
		                             }
		                             return isValid;	// return false will stop the form submission
	                              },
	                              success: function(data){
	                                 $.messager.progress('close');
	                                 if(data == 'success'){
	                                     $("#newDialog").dialog('destroy');
	                                     $('#dg').datagrid('reload');
	                                     $.messager.show({
	                                                    title : '消息提示',
														msg : '发送成功！',
														timeout : 1000,
														showType : 'slide',
														style : {
															right : '',
															bottom : ''
														}
										});
	                                 }
	                              }
                     });
                }
            }, {
                text : '关闭',
                iconCls : 'icon-cancel',
                handler : function() {
                    $("#newDialog").dialog('destroy');
                }
            } ],
        });
	  }
	  
	  
	  function toBatchEdit(type){
	     var rows = $("#dg").datagrid('getSelections');
	     if(rows.length==0){
	        $.messager.alert('提示信息', '请选择至少一条数据!', 'warning');
	        return false;
	     }
	     var ids = "";
		for (var x = 0; x < rows.length; x++) {
			if (x == 0) {
			   ids = rows[x].id;
			} else {
			   ids = ids + "," + rows[x].id;
			}
		}
	     $('<div></div>').dialog({
            id : 'newDialog',
            title : '批量编辑',
            maximized:true,
            closed : false,
            cache : false,
            href : '/hgerp/product/toBatchEdit?ids='+ids+'&type='+type,
            modal : false,
            onLoad : function() {
                //初始化表单数据
            },
            onClose : function() {
                $(this).dialog('destroy');
            },
            buttons : [{
                text : '确定',
                iconCls : 'icon-ok',
                handler : function() {
                    $.messager.progress({ 
                                  title: '提示', 
                                  msg: '加载中，请稍候……', 
                                  text: '' 
                    });
                	$('#fm').form('submit', { 
	                               url: '/hgerp/product/doBatchEdit',
	                               onSubmit: function(){
		                             var isValid = $(this).form('validate');
		                             if(!isValid){
		                               $.messager.progress('close');
		                             }
		                             return isValid;	// return false will stop the form submission
	                              },
	                              success: function(data){
	                                 $.messager.progress('close');
	                                 if(data == 'success'){
	                                     $("#newDialog").dialog('destroy');
	                                     $('#dg').datagrid('reload');
	                                     $.messager.show({
	                                                    title : '消息提示',
														msg : '发送成功！',
														timeout : 1000,
														showType : 'slide',
														style : {
															right : '',
															bottom : ''
														}
										});
	                                 }
	                              }
                     });
                }
            }, {
                text : '关闭',
                iconCls : 'icon-cancel',
                handler : function() {
                    $("#newDialog").dialog('destroy');
                }
            } ],
        });
	  }
	  
	  
	 function exportAfterForging() {
			var rows = $("#dg").datagrid('getSelections');
			if (rows.length > 0) {
			
			   $.messager.confirm('确认信息', '确定导出吗?', function(r){
				if (r){
				    $.messager.progress({ 
                                  title: '提示', 
                                  msg: '加载中，请稍候……', 
                                  text: '' 
                    });
					var ids = "";
				    for (var x = 0; x < rows.length; x++) {
					if (x == 0) {
						ids = rows[x].id;
					} else {
						ids = ids + "," + rows[x].id;
					}
				}
				   window.open("/hgerp/product/exportAfterForging?ids=" + ids);
				   $.messager.progress('close');
				}
			});
			
			} else {
				$.messager.alert('提示信息', '请选择至少一条数据!', 'warning');
			}
		}
		
		function exportjg() {
			var rows = $("#dg").datagrid('getSelections');
			if (rows.length > 0) {
			
			   $.messager.confirm('确认信息', '确定导出吗?', function(r){
				if (r){
					var ids = "";
				    for (var x = 0; x < rows.length; x++) {
					if (x == 0) {
						ids = rows[x].id;
					} else {
						ids = ids + "," + rows[x].id;
					}
				}
				   window.open("/hgerp/product/exportJG?ids=" + ids);
				}
			});
			
			} else {
				$.messager.alert('提示信息', '请选择至少一条数据!', 'warning');
			}
		}
	
	//导出二次热处理施工检验单
		function exportxn() {
			var rows = $("#dg").datagrid('getSelections');
			if (rows.length > 0) {
			
			   $.messager.confirm('确认信息', '确定导出吗?', function(r){
				if (r){
					var ids = "";
				    for (var x = 0; x < rows.length; x++) {
					if (x == 0) {
						ids = rows[x].id;
					} else {
						ids = ids + "," + rows[x].id;
					}
				}
				   window.open("/hgerp/product/exportXn?ids=" + ids);
				}
			});
			
			} else {
				$.messager.alert('提示信息', '请选择至少一条数据!', 'warning');
			}
		}

     //导出滚动表
	 function exportAllInfos() {
			   $.messager.confirm('确认信息', '确定导出吗?', function(r){
				if (r){
				    $.messager.progress({ 
                                  title: '提示', 
                                  msg: '加载中，请稍候……', 
                                  text: '' 
                    });
				   window.open("/hgerp/product/exportAllInfos");
				   $.messager.progress('close');
				}
			});
		}
     
     //添加标记
     function addMarkup(){
	     var rows = $("#dg").datagrid('getSelections');
	     if(rows.length==0){
	        $.messager.alert('提示信息', '请选择至少一条数据!', 'warning');
	        return false;
	     }
	     var ids = "";
		for (var x = 0; x < rows.length; x++) {
			if (x == 0) {
			   ids = rows[x].id;
			} else {
			   ids = ids + "," + rows[x].id;
			}
		}
	     $('<div></div>').dialog({
            id : 'newDialog',
            title : '添加标记',
            width : 400,
            height:200,
            closed : false,
            cache : false,
            href : '/hgerp/product/addMarkup?ids='+ids+'',
            modal : false,
            onLoad : function() {
                //初始化表单数据
            },
            onClose : function() {
                $(this).dialog('destroy');
            },
            buttons : [{
                text : '确定',
                iconCls : 'icon-ok',
                handler : function() {
                    $.messager.progress({ 
                                  title: '提示', 
                                  msg: '加载中，请稍候……', 
                                  text: '' 
                    });
                	$('#fm').form('submit', { 
	                               url: '/hgerp/product/doAddMarkup',
	                               onSubmit: function(){
		                             var isValid = $(this).form('validate');
		                             if(!isValid){
		                               $.messager.progress('close');
		                             }
		                             return isValid;	// return false will stop the form submission
	                              },
	                              success: function(data){
	                                 $.messager.progress('close');
	                                 if(data == 'success'){
	                                     $("#newDialog").dialog('destroy');
	                                     $('#dg').datagrid('reload');
	                                     $.messager.show({
	                                                    title : '消息提示',
														msg : '发送成功！',
														timeout : 1000,
														showType : 'slide',
														style : {
															right : '',
															bottom : ''
														}
										});
	                                 }
	                              }
                     });
                }
            }, {
                text : '关闭',
                iconCls : 'icon-cancel',
                handler : function() {
                    $("#newDialog").dialog('destroy');
                }
            } ],
        });
	  }
	  
	  
	 function inStore(){
	    var rows = $("#dg").datagrid('getSelections');
	    if(rows.length==0){
	       $.messager.alert('提示信息', '请至少选择一条数据!', 'warning');
	       return false;
	    }
	    var ids = "";
		for (var x = 0; x < rows.length; x++) {
		  if (x == 0) {
			  ids = rows[x].id;
		  } else {
			  ids = ids + "," + rows[x].id;
		  }
		 }
		 $.messager.confirm('提示信息', '确定继续操作吗?', function(r){
				if (r){
					$.ajax({
									type : "POST",
									url : "/hgerp/product/inStore",
									data : {
										ids : ids
									},
									success : function(data) {
									   if(data=='success'){
									     $.messager.show({
											title : '消息提示',
											msg : '操作成功！',
											timeout : 1000,
											showType : 'slide',
											style : {
												right : '',
												bottom : ''
											}
										});
										$('#dg').datagrid('clearSelections');
										$('#dg').datagrid('reload');//
									   }else{
									      $.messager.alert('提示信息', '只有待入库的产品才能入库,请仔细检查!', 'warning');
									   }
									}
								})
				}
			});
	  }
	  
	  
	function addSample(){
	    var rows = $("#dg").datagrid('getSelections');
	    if(rows.length!=1){
	       $.messager.alert('提示信息', '请选择一条数据进行操作!', 'warning');
	       return false;
	    }
	     $('<div></div>').dialog({
            id : 'newDialog',
            title : '拆分',
            maximized:true,
            closed : false,
            cache : false,
            href : '/hgerp/product/addSample?id='+rows[0].id,
            modal : true,
            onLoad : function() {
                //初始化表单数据
            },
            onClose : function() {
                $(this).dialog('destroy');
            },
            buttons : [{
                text : '确定',
                iconCls : 'icon-ok',
                handler : function() {
                   $.messager.progress({ 
                                  title: '提示', 
                                  msg: '加载中，请稍候……', 
                                  text: '' 
                    });
                   var isValid = $("#fm").form('validate');
					if (isValid) {
						var rows2 = $('#myList').datagrid('getRows');
						var xx = {};
						if (endEditing()) {
							$('#myList').datagrid('acceptChanges');
						}
						for (var i = 0; i < rows2.length; i++) {
							for ( var key in rows2[i]) {
								xx["listP[" + i + "]."+ key] = rows2[i][key];
							}
						}
						var formData = $("#fm").serializeArray();
						for ( var n in formData) {
							var data = formData[n];
							xx[data.name] = data.value;
						}
						$.ajax({    url : '/hgerp/product/doAddSample',
									data : xx,
									success : function(res) {
									        $.messager.progress('close');
											if (res == 'success') {
												$("#newDialog").dialog('destroy');
												$.messager.show({
													title : '消息提示',
													msg : '操作成功！',
													timeout : 1000,
													showType : 'slide',
													style : {
														right : '',
														bottom : ''
													}
												});
												$('#dg').datagrid('reload');
											}
											if (res == 'fail') {
											    $.messager.alert('提示信息', '至少添加一行!', 'warning');
											}
											if (res == 'qty') {
											    $.messager.alert('提示信息', '数量必填!', 'warning');
											}
									}
								})
							} else {
							    $.messager.progress('close');
                                $.messager.alert('提示信息', '请将数据填写完整!', 'warning');
							}
                }
            }, {
                text : '关闭',
                iconCls : 'icon-cancel',
                handler : function() {
                    $("#newDialog").dialog('destroy');
                }
            } ],

        });
	  }
	  
	  
	  //编辑序号
     function toUpdateOrderNum(){
	     var rows = $("#dg").datagrid('getSelections');
	     if(rows.length!=1){
	        $.messager.alert('提示信息', '请选择一条数据!', 'warning');
	        return false;
	     }
	     $('<div></div>').dialog({
            id : 'newDialog',
            title : '编辑序号',
            width : 600,
            height:400,
            closed : false,
            cache : false,
            href : '/hgerp/product/toUpdateOrderNum?id='+rows[0].id,
            modal : false,
            onLoad : function() {
                //初始化表单数据
            },
            onClose : function() {
                $(this).dialog('destroy');
            },
            buttons : [{
                text : '确定',
                iconCls : 'icon-ok',
                handler : function() {
                    $.messager.progress({ 
                                  title: '提示', 
                                  msg: '加载中，请稍候……', 
                                  text: '' 
                    });
                	$('#fm').form('submit', { 
	                               url: '/hgerp/product/doUpdateOrderNum',
	                               onSubmit: function(){
		                             var isValid = $(this).form('validate');
		                             if(!isValid){
		                               $.messager.progress('close');
		                             }
		                             return isValid;	// return false will stop the form submission
	                              },
	                              success: function(data){
	                                 $.messager.progress('close');
	                                 if(data == 'success'){
	                                     $("#newDialog").dialog('destroy');
	                                     $('#dg').datagrid('reload');
	                                     $.messager.show({
	                                                    title : '消息提示',
														msg : '操作成功！',
														timeout : 1000,
														showType : 'slide',
														style : {
															right : '',
															bottom : ''
														}
										});
	                                 }
	                                 if(data == 'qty'){
	                                     $.messager.alert('提示信息', '数量必填!', 'warning');
	                                 }
	                                 if(data == 'fail'){
	                                     $.messager.alert('提示信息', '序号重复!', 'warning');
	                                 }
	                              }
                     });
                }
            }, {
                text : '关闭',
                iconCls : 'icon-cancel',
                handler : function() {
                    $("#newDialog").dialog('destroy');
                }
            } ],
        });
	  }
	function breakCellStyler(value,row,index){
			if (value){
				return 'background-color:green;color:white;';
			}
     }
    
    function exportOutInfo() {
			var rows = $("#dg").datagrid('getSelections');
			if (rows.length > 0) {
			
			   $.messager.confirm('确认信息', '确定导出吗?', function(r){
				if (r){
				    $.messager.progress({ 
                                  title: '提示', 
                                  msg: '加载中，请稍候……', 
                                  text: '' 
                    });
					var ids = "";
				    for (var x = 0; x < rows.length; x++) {
					if (x == 0) {
						ids = rows[x].id;
					} else {
						ids = ids + "," + rows[x].id;
					}
				}
				   window.open("/hgerp/product/exportOutInfo?ids=" + ids);
				   $.messager.progress('close');
				}
			});
			
			} else {
				$.messager.alert('提示信息', '请选择至少一条数据!', 'warning');
			}
		}
		
		
	function breakOut(){
	    if(typeof  endEditing=="function"){
	       endEditing();
	    }
	    var rows = $("#dg").datagrid('getSelections');
	    if(rows.length==0){
	       $.messager.alert('提示信息', '请至少选择一条数据!', 'warning');
	       return false;
	    }
	    var ids = "";
		for (var x = 0; x < rows.length; x++) {
		  if (x == 0) {
			  ids = rows[x].id;
		  } else {
			  ids = ids + "," + rows[x].id;
		  }
		 }
		 $.messager.confirm('提示信息', '确定破坏吗?', function(r){
				if (r){
					$.ajax({
							type : "POST",
							url : "/hgerp/product/breakOut",
							data : {
								ids : ids
							},
							success : function(data) {
								if(data=='success'){
									$.messager.show({
										title : '消息提示',
										msg : '操作成功！',
										timeout : 1000,
										showType : 'slide',
										style : {
											right : '',
											bottom : ''
										}
									});
									$('#dg').datagrid('clearSelections');
									   $('#dg').datagrid('reload');//
									}else{
									   $.messager.alert('提示信息', '只有待入库的产品才能入库,请仔细检查!', 'warning');
									}
								}
							})
				}
			});
	  }	
	  
	  
	  	//导出外协施工单
		function exportForgingOut() {
			var rows = $("#dg").datagrid('getSelections');
			if (rows.length > 0) {
			
			   $.messager.confirm('确认信息', '确定导出吗?', function(r){
				if (r){
					var ids = "";
				    for (var x = 0; x < rows.length; x++) {
					if (x == 0) {
						ids = rows[x].id;
					} else {
						ids = ids + "," + rows[x].id;
					}
				}
				   window.open("/hgerp/product/exportForgingOut?ids=" + ids);
				}
			});
			
			} else {
				$.messager.alert('提示信息', '请选择至少一条数据!', 'warning');
			}
		}
		
		
    function qtyTotal(){
	    var rows = $("#dg").datagrid('getSelections');
	    if(rows.length==0){
	       $.messager.alert('提示信息', '请至少选择一条数据进行操作!', 'warning');
	       return false;
	    }
	    var ids = "";
		for (var x = 0; x < rows.length; x++) {
		  if (x == 0) {
			  ids = rows[x].id;
		  } else {
			  ids = ids + "," + rows[x].id;
		  }
		 }
		 	$('<div></div>').dialog({
            id : 'newDialog',
            title : "查看生产总数",
            width:500,
            height:150,
            closed : false,
            cache : false,
            href : "/hgerp/product/qtyTotal?ids="+ids,
            modal : true,
            onLoad : function() {
                //初始化表单数据
            },
            onClose : function() {
                $(this).dialog('destroy');
            },
            buttons : [{
                text : '关闭',
                iconCls : 'icon-cancel',
                handler : function() {
                    $("#newDialog").dialog('destroy');
                }
            } ],

        });
	  }
	  
	  
	  	//导出检验施工单
		function exportInspectInfo() {
			var rows = $("#dg").datagrid('getSelections');
			if (rows.length > 0) {
			
			   $.messager.confirm('确认信息', '确定导出吗?', function(r){
				if (r){
					var ids = "";
				    for (var x = 0; x < rows.length; x++) {
					if (x == 0) {
						ids = rows[x].id;
					} else {
						ids = ids + "," + rows[x].id;
					}
				}
				   window.open("/hgerp/product/exportInspectInfo?ids=" + ids);
				}
			});
			
			} else {
				$.messager.alert('提示信息', '请选择至少一条数据!', 'warning');
			}
		}
		
		
	function qtyTotalWeight(){
	    var rows = $("#dg").datagrid('getSelections');
	    if(rows.length==0){
	       $.messager.alert('提示信息', '请至少选择一条数据进行操作!', 'warning');
	       return false;
	    }
	    var ids = "";
		for (var x = 0; x < rows.length; x++) {
		  if (x == 0) {
			  ids = rows[x].id;
		  } else {
			  ids = ids + "," + rows[x].id;
		  }
		 }
		 	$('<div></div>').dialog({
            id : 'newDialog',
            title : "查看生产总数",
            width:500,
            height:250,
            closed : false,
            cache : false,
            href : "/hgerp/product/qtyTotalWeight?ids="+ids,
            modal : true,
            onLoad : function() {
                //初始化表单数据
            },
            onClose : function() {
                $(this).dialog('destroy');
            },
            buttons : [{
                text : '关闭',
                iconCls : 'icon-cancel',
                handler : function() {
                    $("#newDialog").dialog('destroy');
                }
            } ],

        });
	  }
	  
	  	//导出锻造找料单
		function exportFindBlank() {
			var rows = $("#dg").datagrid('getSelections');
			if (rows.length > 0) {
			
			   $.messager.confirm('确认信息', '确定导出吗?', function(r){
				if (r){
					var ids = "";
				    for (var x = 0; x < rows.length; x++) {
					if (x == 0) {
						ids = rows[x].id;
					} else {
						ids = ids + "," + rows[x].id;
					}
				}
				   window.open("/hgerp/product/exportFindBlank?ids=" + ids);
				}
			});
			
			} else {
				$.messager.alert('提示信息', '请选择至少一条数据!', 'warning');
			}
		}
		
	function showOperateRecord(){
	    var rows = $("#dg").datagrid('getSelections');
	    if(rows.length!=1){
	       $.messager.alert('提示信息', '请选择一条数据进行操作!', 'warning');
	       return false;
	    }
		 	$('<div></div>').dialog({
            id : 'newDialog',
            title : "查看操作记录",
            width:800,
            height:450,
            closed : false,
            cache : false,
            href : "/hgerp/product/showOperateRecord?productId="+rows[0].id,
            modal : true,
            onLoad : function() {
                //初始化表单数据
            },
            onClose : function() {
                $(this).dialog('destroy');
            },
            buttons : [{
                text : '关闭',
                iconCls : 'icon-cancel',
                handler : function() {
                    $("#newDialog").dialog('destroy');
                }
            } ],

        });
	  }
	  
	  function formatterstate01(val,row){
		   if(val==20){
		      return "<span style='background:green;color:white;font-weight:600'>申请</span>";
		   }else{
		      return "正常";
		   }
		}
		
		var totals = 0;
		function onCheck(rowIndex,rowData){
		     var rows = $("#dg").datagrid('getSelections');
		     var totals = 0;
		     var t = window.parent.document.getElementById("totalWeight");
		     for(x in rows){
		        totals = totals+rows[x].qty*rows[x].blank_weight
		     }
		     $(t).val(totals);
		}
		
	  //判定不合格状态
     function toUpdateNcrState(){
	     var rows = $("#dg").datagrid('getSelections');
	     if(rows.length!=1){
	        $.messager.alert('提示信息', '请选择一条数据!', 'warning');
	        return false;
	     }
	     $('<div></div>').dialog({
            id : 'newDialog',
            title : '修改不合格处置方式',
            width : 400,
            height: 200,
            closed : false,
            cache : false,
            href : '/hgerp/product/toUpdateNcrState?id='+rows[0].id,
            modal : false,
            onLoad : function() {
                //初始化表单数据
            },
            onClose : function() {
                $(this).dialog('destroy');
            },
            buttons : [{
                text : '确定',
                iconCls : 'icon-ok',
                handler : function() {
                    $.messager.progress({ 
                                  title: '提示', 
                                  msg: '加载中，请稍候……', 
                                  text: '' 
                    });
                	$('#fm').form('submit', { 
	                               url: '/hgerp/product/updateNcrState',
	                               onSubmit: function(){
		                             var isValid = $(this).form('validate');
		                             if(!isValid){
		                               $.messager.progress('close');
		                             }
		                             return isValid;	// return false will stop the form submission
	                              },
	                              success: function(data){
	                                 $.messager.progress('close');
	                                 if(data == 'success'){
	                                     $("#newDialog").dialog('destroy');
	                                     $('#dg').datagrid('reload');
	                                     $.messager.show({
	                                                    title : '消息提示',
														msg : '发送成功！',
														timeout : 1000,
														showType : 'slide',
														style : {
															right : '',
															bottom : ''
														}
										});
	                                 }
	                              }
                     });
                }
            }, {
                text : '关闭',
                iconCls : 'icon-cancel',
                handler : function() {
                    $("#newDialog").dialog('destroy');
                }
            } ],
        });
	  }
		
	/*]]>*/
	</script>
</div>
</body>
</html>
